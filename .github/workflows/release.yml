name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    # CORRECCIÓN: Exportar la output para que otros jobs la vean
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
          body: |
            ## Chat gRPC Multi-Client ${{ github.ref }}
            
            ### Características
            - ✅ Servidor gRPC en Go
            - ✅ Cliente Go con audio y transferencia de archivos
            - ✅ Cliente Python con audio
            - ✅ Cliente Java con audio
            - ✅ Cliente C básico
            
            ### Instalación
            Ver README.md para instrucciones de instalación.

  build-binaries:
    name: Build Binaries
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: darwin
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler portaudio19-dev libprotobuf-dev
      
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install protobuf portaudio
      
      - name: Build Go Server
        run: |
          cd chat-server
          # "go mod tidy" arregla dependencias faltantes y actualiza go.sum
          go mod tidy
          go build -o server-${{ matrix.platform }}-amd64 .
      
      - name: Build Go Client
        run: |
          cd go-client
          go mod tidy
          go build -o client-go-${{ matrix.platform }}-amd64 .
      
      # Nota: Asegúrate de que tu Makefile en c-client genera un archivo llamado 'client'
      - name: Build C Client
        run: |
          cd c-client
          make
          mv client client-c-${{ matrix.platform }}-amd64
      
      - name: Upload Server Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./chat-server/server-${{ matrix.platform }}-amd64
          asset_name: server-${{ matrix.platform }}-amd64
          asset_content_type: application/octet-stream
      
      - name: Upload Go Client Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./go-client/client-go-${{ matrix.platform }}-amd64
          asset_name: client-go-${{ matrix.platform }}-amd64
          asset_content_type: application/octet-stream
      
      - name: Upload C Client Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./c-client/client-c-${{ matrix.platform }}-amd64
          asset_name: client-c-${{ matrix.platform }}-amd64
          asset_content_type: application/octet-stream